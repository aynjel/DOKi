image: node:10.8.0
options:
    max-time: 15
    docker: true
    size: 2x

pipelines:
    # default:
    #     - step:
    #         name: Pipeline Cypress E2E
    #         caches:
    #             - npm
    #             - cypress
    #         image: cypress/base:10
    #         script:
    #             - npm ci
    #             - npx cypress run
    #         artifacts:
    #             - cypress/screenshots/**
    #             - cypress/reports/**
    #             - cypress/videos/**
    branches:
        '{master,dev_branch}':
            - step:
                name: PWA E2E Tests
                caches:
                    - docker
                    - composer
                    - node 
                    - npm
                    - cypress
                #image: cypress/base:10
                image: docker/compose:latest
                services:
                    - docker
                size: 2x
                script:
                    - echo "Building and then Test the app..."
                    #- docker-compose -f docker-compose-cypress.yml build 
                    - docker-compose -f docker-compose-cypress.yml up --exit-code-from cypress
                artifacts:
                    # Include built output 
                    - cypress/screenshots/**
                    - cypress/reports/**
                    - cypress/videos/**
            - step:
                name: Deploy to Test Env
                deployment: staging
                script:
                    - pipe: atlassian/sftp-deploy:0.5.6
                      variables:
                        USER: $DPP_USER
                        SERVER: $DPP_SERVER
                        REMOTE_PATH: $DPP_REMOTE_PATH
                        LOCAL_PATH: $DPP_LOCAL_PATH
                        PASSWORD: $DPP_PASSWORD
                        #DELETE_FLAG: 'false' # Don't delete existing files
                        #EXTRA_ARGS: "--exclude=.bitbucket/ --exclude=.git/ --exclude=bitbucket-pipelines.yml --exclude=.gitignore" # Ignore these

definitions:
    caches:
        npm: $HOME/.npm
        cypress: $HOME/.cache/Cypress
    services:
        docker:
            memory: 4096